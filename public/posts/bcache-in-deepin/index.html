<!DOCTYPE html>
<html lang="zh-hant">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Bcache in Deepin | MYML.DEV</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Bcache 使用 Bcache 是什么 Bcache 是 Linux 下的一个块缓存内核模块，可用于使用单个固态硬盘为一个或多个机械硬盘加速，也可用于使用本地磁盘为网络磁盘的加速。
Bcache 有比较灵活的缓存模式，支持安全读写缓存(writethrough)、高性能读写缓存(writeback)、只读缓存(writearound)、停用缓存(none)等模式，并且可在线动态调整。
Bcache 还会自动识别顺序写入，当发现正在进行顺序写入时跳过缓存层，以减少缓存设备(固态硬盘)的损耗，延长固态硬盘的寿命。
快速开始 ！警告：使用 Bcache 需要格式化相应设备，需谨慎操作。
安装 deepin 仓库已存在 Bcache 1.0.8 版本，可直接在终端使用 sudo apt install bcache-tools 命令安装。
格式化 安装完成后，可使用 sudo make-cache -C /dev/nvmeX -B /dev/sdX 格式化缓存设备(nvmeX)和后端设备(sdX)，并自动关联两个设备。
可能出现的错误
Device or resource busy 设备被占用，用 df 命令查看设备是不是已经被挂载使用，用 umount 取消挂载。 Device /dev/sdX already has a non-bcache superblock 设备已存在文件系统，为避免文件丢失，请在备份文件后，使用 sudo wipefs -a /dev/sdX 清除设备。 在顺利格式化后，会出现一个 /dev/bcache0 设备，大小与后端设备一致，可以当作普通的块设备使用。 例如使用 sudo mkfs.btrfs /dev/bcache0 格式化为 btrfs 文件系统格式，使用 sudo mount /deb/bcache0 /mnt 挂载。">
    <meta name="generator" content="Hugo 0.101.0" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Bcache in Deepin" />
<meta property="og:description" content="Bcache 使用 Bcache 是什么 Bcache 是 Linux 下的一个块缓存内核模块，可用于使用单个固态硬盘为一个或多个机械硬盘加速，也可用于使用本地磁盘为网络磁盘的加速。
Bcache 有比较灵活的缓存模式，支持安全读写缓存(writethrough)、高性能读写缓存(writeback)、只读缓存(writearound)、停用缓存(none)等模式，并且可在线动态调整。
Bcache 还会自动识别顺序写入，当发现正在进行顺序写入时跳过缓存层，以减少缓存设备(固态硬盘)的损耗，延长固态硬盘的寿命。
快速开始 ！警告：使用 Bcache 需要格式化相应设备，需谨慎操作。
安装 deepin 仓库已存在 Bcache 1.0.8 版本，可直接在终端使用 sudo apt install bcache-tools 命令安装。
格式化 安装完成后，可使用 sudo make-cache -C /dev/nvmeX -B /dev/sdX 格式化缓存设备(nvmeX)和后端设备(sdX)，并自动关联两个设备。
可能出现的错误
Device or resource busy 设备被占用，用 df 命令查看设备是不是已经被挂载使用，用 umount 取消挂载。 Device /dev/sdX already has a non-bcache superblock 设备已存在文件系统，为避免文件丢失，请在备份文件后，使用 sudo wipefs -a /dev/sdX 清除设备。 在顺利格式化后，会出现一个 /dev/bcache0 设备，大小与后端设备一致，可以当作普通的块设备使用。 例如使用 sudo mkfs.btrfs /dev/bcache0 格式化为 btrfs 文件系统格式，使用 sudo mount /deb/bcache0 /mnt 挂载。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://myml.dev/posts/bcache-in-deepin/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-19T00:09:58+08:00" />
<meta property="article:modified_time" content="2022-06-19T00:09:58+08:00" />

<meta itemprop="name" content="Bcache in Deepin">
<meta itemprop="description" content="Bcache 使用 Bcache 是什么 Bcache 是 Linux 下的一个块缓存内核模块，可用于使用单个固态硬盘为一个或多个机械硬盘加速，也可用于使用本地磁盘为网络磁盘的加速。
Bcache 有比较灵活的缓存模式，支持安全读写缓存(writethrough)、高性能读写缓存(writeback)、只读缓存(writearound)、停用缓存(none)等模式，并且可在线动态调整。
Bcache 还会自动识别顺序写入，当发现正在进行顺序写入时跳过缓存层，以减少缓存设备(固态硬盘)的损耗，延长固态硬盘的寿命。
快速开始 ！警告：使用 Bcache 需要格式化相应设备，需谨慎操作。
安装 deepin 仓库已存在 Bcache 1.0.8 版本，可直接在终端使用 sudo apt install bcache-tools 命令安装。
格式化 安装完成后，可使用 sudo make-cache -C /dev/nvmeX -B /dev/sdX 格式化缓存设备(nvmeX)和后端设备(sdX)，并自动关联两个设备。
可能出现的错误
Device or resource busy 设备被占用，用 df 命令查看设备是不是已经被挂载使用，用 umount 取消挂载。 Device /dev/sdX already has a non-bcache superblock 设备已存在文件系统，为避免文件丢失，请在备份文件后，使用 sudo wipefs -a /dev/sdX 清除设备。 在顺利格式化后，会出现一个 /dev/bcache0 设备，大小与后端设备一致，可以当作普通的块设备使用。 例如使用 sudo mkfs.btrfs /dev/bcache0 格式化为 btrfs 文件系统格式，使用 sudo mount /deb/bcache0 /mnt 挂载。"><meta itemprop="datePublished" content="2022-06-19T00:09:58+08:00" />
<meta itemprop="dateModified" content="2022-06-19T00:09:58+08:00" />
<meta itemprop="wordCount" content="275">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bcache in Deepin"/>
<meta name="twitter:description" content="Bcache 使用 Bcache 是什么 Bcache 是 Linux 下的一个块缓存内核模块，可用于使用单个固态硬盘为一个或多个机械硬盘加速，也可用于使用本地磁盘为网络磁盘的加速。
Bcache 有比较灵活的缓存模式，支持安全读写缓存(writethrough)、高性能读写缓存(writeback)、只读缓存(writearound)、停用缓存(none)等模式，并且可在线动态调整。
Bcache 还会自动识别顺序写入，当发现正在进行顺序写入时跳过缓存层，以减少缓存设备(固态硬盘)的损耗，延长固态硬盘的寿命。
快速开始 ！警告：使用 Bcache 需要格式化相应设备，需谨慎操作。
安装 deepin 仓库已存在 Bcache 1.0.8 版本，可直接在终端使用 sudo apt install bcache-tools 命令安装。
格式化 安装完成后，可使用 sudo make-cache -C /dev/nvmeX -B /dev/sdX 格式化缓存设备(nvmeX)和后端设备(sdX)，并自动关联两个设备。
可能出现的错误
Device or resource busy 设备被占用，用 df 命令查看设备是不是已经被挂载使用，用 umount 取消挂载。 Device /dev/sdX already has a non-bcache superblock 设备已存在文件系统，为避免文件丢失，请在备份文件后，使用 sudo wipefs -a /dev/sdX 清除设备。 在顺利格式化后，会出现一个 /dev/bcache0 设备，大小与后端设备一致，可以当作普通的块设备使用。 例如使用 sudo mkfs.btrfs /dev/bcache0 格式化为 btrfs 文件系统格式，使用 sudo mount /deb/bcache0 /mnt 挂载。"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        MYML.DEV
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Bcache in Deepin</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-06-19T00:09:58+08:00">June 19, 2022</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="bcache-使用">Bcache 使用</h1>
<h2 id="bcache-是什么">Bcache 是什么</h2>
<p>Bcache 是 Linux 下的一个块缓存内核模块，可用于使用单个固态硬盘为一个或多个机械硬盘加速，也可用于使用本地磁盘为网络磁盘的加速。</p>
<p>Bcache 有比较灵活的缓存模式，支持安全读写缓存(writethrough)、高性能读写缓存(writeback)、只读缓存(writearound)、停用缓存(none)等模式，并且可在线动态调整。</p>
<p>Bcache 还会自动识别顺序写入，当发现正在进行顺序写入时跳过缓存层，以减少缓存设备(固态硬盘)的损耗，延长固态硬盘的寿命。</p>
<h2 id="快速开始">快速开始</h2>
<blockquote>
<p>！警告：使用 Bcache 需要格式化相应设备，需谨慎操作。</p>
</blockquote>
<h3 id="安装">安装</h3>
<p>deepin 仓库已存在 Bcache 1.0.8 版本，可直接在终端使用 <code>sudo apt install bcache-tools</code> 命令安装。</p>
<h3 id="格式化">格式化</h3>
<p>安装完成后，可使用 <code>sudo make-cache -C /dev/nvmeX -B /dev/sdX</code> 格式化缓存设备(nvmeX)和后端设备(sdX)，并自动关联两个设备。</p>
<blockquote>
<p>可能出现的错误</p>
<ul>
<li><em>Device or resource busy</em> 设备被占用，用 df 命令查看设备是不是已经被挂载使用，用 umount 取消挂载。</li>
<li><em>Device /dev/sdX already has a non-bcache superblock</em> 设备已存在文件系统，为避免文件丢失，请在<strong>备份文件</strong>后，使用 <code>sudo wipefs -a /dev/sdX</code> 清除设备。</li>
</ul>
</blockquote>
<p>在顺利格式化后，会出现一个 /dev/bcache0 设备，大小与后端设备一致，可以当作普通的块设备使用。
例如使用 <code>sudo mkfs.btrfs /dev/bcache0</code> 格式化为 btrfs 文件系统格式，使用 <code>sudo mount /deb/bcache0 /mnt</code> 挂载。</p>
<h3 id="调整缓存模式">调整缓存模式</h3>
<p>默认情况下，Bcache 使用安全读写缓存(writethrough)模式，在该模式下，数据落盘会同时写入到固态硬盘和机械硬盘上，以避免固态硬盘损坏导致数据丢失，但这样会影响写入速度。在无严格需求的情况下，可改为高性能读写(writeback)模式，该模式下数据会先写入到固态硬盘，再定时同步到机械硬盘。</p>
<p>查看当前缓存模式 <code>cat /sys/block/bcache0/bcache/cache_mode</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>writethrough<span style="color:#f92672">]</span> writeback writearound none
</span></span></code></pre></div><p>动态修改缓存模式 <code>echo writeback | sudo tee /sys/block/bcache0/bcache/cache_mode</code>。</p>
<blockquote>
<p>修改实时时效</p>
</blockquote>
<h2 id="效果测试">效果测试</h2>
<h3 id="使用-fio-进行随机读测试">使用 fio 进行随机读测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo fio -filename<span style="color:#f92672">=</span>/dev/XXX -direct<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -iodepth <span style="color:#ae81ff">1</span> -thread -rw<span style="color:#f92672">=</span>randread -ioengine<span style="color:#f92672">=</span>psync -bs<span style="color:#f92672">=</span>16k -size<span style="color:#f92672">=</span>5G -numjobs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> -runtime<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> -group_reporting -name<span style="color:#f92672">=</span>mytest
</span></span></code></pre></div><ul>
<li>固态硬盘速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>433MiB/s <span style="color:#f92672">(</span>454MB/s<span style="color:#f92672">)</span>, 433MiB/s-433MiB/s <span style="color:#f92672">(</span>454MB/s-454MB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>4330MiB <span style="color:#f92672">(</span>4540MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>10002-10002msec
</span></span></code></pre></div><ul>
<li>机械硬盘速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>6664KiB/s <span style="color:#f92672">(</span>6824kB/s<span style="color:#f92672">)</span>, 6664KiB/s-6664KiB/s <span style="color:#f92672">(</span>6824kB/s-6824kB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>65.7MiB <span style="color:#f92672">(</span>68.9MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>10099-10099msec
</span></span></code></pre></div><ul>
<li>Bcache 速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>20.8MiB/s <span style="color:#f92672">(</span>21.8MB/s<span style="color:#f92672">)</span>, 20.8MiB/s-20.8MiB/s <span style="color:#f92672">(</span>21.8MB/s-21.8MB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>211MiB <span style="color:#f92672">(</span>221MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>10140-10140msec
</span></span></code></pre></div><h3 id="使用-fio-进行顺序读测试">使用 fio 进行顺序读测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo fio -filename<span style="color:#f92672">=</span>/dev/XXX -direct<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -iodepth <span style="color:#ae81ff">1</span> -thread -rw<span style="color:#f92672">=</span>read -ioengine<span style="color:#f92672">=</span>psync -bs<span style="color:#f92672">=</span>16k -size<span style="color:#f92672">=</span>5G -numjobs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> -runtime<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> -group_reporting -name<span style="color:#f92672">=</span>mytest
</span></span></code></pre></div><ul>
<li>固态硬盘速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>442MiB/s <span style="color:#f92672">(</span>463MB/s<span style="color:#f92672">)</span>, 442MiB/s-442MiB/s <span style="color:#f92672">(</span>463MB/s-463MB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>3536MiB <span style="color:#f92672">(</span>3707MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>8008-8008msec
</span></span></code></pre></div><ul>
<li>机械硬盘速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>295MiB/s <span style="color:#f92672">(</span>309MB/s<span style="color:#f92672">)</span>, 295MiB/s-295MiB/s <span style="color:#f92672">(</span>309MB/s-309MB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>2357MiB <span style="color:#f92672">(</span>2472MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>8002-8002msec
</span></span></code></pre></div><ul>
<li>Bcache 速度</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Run status group <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>all jobs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>   READ: bw<span style="color:#f92672">=</span>349MiB/s <span style="color:#f92672">(</span>366MB/s<span style="color:#f92672">)</span>, 349MiB/s-349MiB/s <span style="color:#f92672">(</span>366MB/s-366MB/s<span style="color:#f92672">)</span>, io<span style="color:#f92672">=</span>2795MiB <span style="color:#f92672">(</span>2931MB<span style="color:#f92672">)</span>, run<span style="color:#f92672">=</span>8002-8002msec
</span></span></code></pre></div><h3 id="测试结论">测试结论</h3>
<p>从测试结果来看，Bcache 两倍的随机读性能（和固态硬盘的性能成正比），在实际使用中体现为 deepin 在输入用户密码后更快的显示桌面，日常软件的能更快的启动。</p>
<h2 id="常用操作">常用操作</h2>
<ul>
<li>
<p>格式化缓存设备</p>
<p><code>sudo make-bcache -C /dev/nvmeX</code></p>
</li>
<li>
<p>格式化后端设备</p>
<p><code>sudo make-bcache -B /dev/sdX</code></p>
</li>
<li>
<p>查看设备信息</p>
<p><code>sudo bcache-super-show /dev/XXXX</code></p>
</li>
<li>
<p>附加缓存设备到后端设备</p>
<p><code>echo $(cset.uuid) | sudo tee /sys/block/bcache0/bcache/attach</code></p>
<blockquote>
<p>cset.uuid 使用 bcache-super-show 查看</p>
<p>一个缓存设备可附加到多个后端设备</p>
</blockquote>
</li>
<li>
<p>从后端设备分离缓存设备</p>
<p><code>echo $(cset.uuid) | sudo tee /sys/block/bcache0/bcache/detach</code></p>
</li>
<li>
<p>停用缓存设备</p>
<p><code>echo 1 | sudo tee /sys/fs/bcache/$(cset.uuid)/unregister</code></p>
<blockquote>
<p>为避免文件丢失，缓存设备应该先分离再停用。</p>
</blockquote>
</li>
<li>
<p>停用后端设备</p>
<p><code>echo 1 | sudo tee /sys/block/bcache0/bcache/stop</code></p>
</li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://myml.dev/" >
    &copy;  MYML.DEV 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
